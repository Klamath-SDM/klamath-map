---
title: "Klamath Basin Existing Maps Crosswalk Material"
author: "Badhia Yunes Katz"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(httr)
library(jsonlite)
library(leaflet)
library(janitor)

# knitr::opts_chunk$set(echo = TRUE)
```

The goal of this markdown is to pull in data from existing maps and select the layers we are interested on using for crosswalk with or shiny map. The following resources are being used:

  * [USGS Dam Removal Monitoring Map](https://www.arcgis.com/apps/mapviewer/index.html?webmap=646c4ea7f4224845bd4c3c5a4f2f3e4e) 
  * [SFEI Klmath Basin Monitoring Map](https://sfei.maps.arcgis.com/apps/MapSeries/index.html?appid=9b10920b676b4dfebce14f8c4ea70c4d&entry=1)



### Pulling layers from [USGS Dam Removal Monitoring Map](https://www.arcgis.com/apps/mapviewer/index.html?webmap=646c4ea7f4224845bd4c3c5a4f2f3e4e) 

```{r, echo=FALSE}
# Base FeatureServer URL
base_url <- "https://services.arcgis.com/v01gqwM5QqNysAAi/arcgis/rest/services/Klamath_Web_Map/FeatureServer"

# Query the layers endpoint
response <- httr::GET(paste0(base_url, "?f=json"))
content <- content(response, "text")
layers <- fromJSON(content)$layers
```

Layers included on this map:

```{r, echo=FALSE}
# Check layer names and indices
print(layers)
```

```{r, include=FALSE, warning=FALSE}
download_layer <- function(layer_id, layer_name, output_dir) {
  layer_url <- paste0(base_url, "/", layer_id, "/query")
  response <- httr::GET(layer_url, query = list(where = "1=1", outFields = "*", f = "geojson"))
  geojson_data <- content(response, "text", encoding = "UTF-8")
  sf_data <- st_read(geojson_data, quiet = TRUE)
  file_name <- paste0(output_dir, "/", layer_name, ".shp")
  st_write(sf_data, file_name, delete_layer = TRUE, quiet = TRUE)
  message("Saved: ", file_name)
}

output_dir <- "data-raw//usgs_dam_removal_map/klamath_map_shapefiles"
dir.create(output_dir, showWarnings = FALSE)

for (i in seq_len(nrow(layers))) {
  download_layer(layers$id[i], layers$name[i], output_dir)
}
```


```{r, include=FALSE}
# commenting out since this was a test, leaving it here for now util I make sure that everything works as expected on function below and map is succesully added to Shiny

# bed_sed_shapefile <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/USGS_IronGate_Reservoir.shp") |> 
#   clean_names() 
# 
# dams_tbremoved_shapefile <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/Dams_to_be_removed.shp") |> 
#   clean_names()
# 
# dams <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/Dams.shp") |> 
#   clean_names()
# 
# kl_river_corridor <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/Klamath_River_Corridor.shp") |> 
#   clean_names()
# 
# copco_res_bedsed <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/USGS_Copco_Reservoir_bed_sediment_cores.shp") |> 
#   clean_names()
# 
# estuary_bedsed <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/USGS_Estuary_bed_sediment_samples.shp") |> 
#   clean_names()
# 
# ig_reservoir_bedsed <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/USGS_IronGate_Reservoir.shp") |> 
#   clean_names()
# 
# geomorphic_reaches <- st_read("data-raw/usgs_dam_removal_map/klamath_map_shapefiles/USGS_Mainstem_Geomorphic_Reaches.shp") |> 
#   clean_names()
```


```{r, include=FALSE}
folder_path <- "data-raw/usgs_dam_removal_map/klamath_map_shapefiles/"
shapefiles <- list.files(folder_path, pattern = "\\.shp$", full.names = TRUE)
shapefile_list <- map(shapefiles, ~st_read(.x) |> clean_names())
names(shapefile_list) <- gsub(".shp$", "", basename(shapefiles))  

sapply(shapefile_list, function(x) st_geometry_type(x))

usgs_damrev_monitoring_map <- leaflet() |>  addTiles() 

for (shapefile_name in names(shapefile_list)) {
  shapefile <- shapefile_list[[shapefile_name]]
  geom_type <- st_geometry_type(shapefile)
  if ("POLYGON" %in% geom_type | "MULTIPOLYGON" %in% geom_type) {
    usgs_damrev_monitoring_map <- usgs_damrev_monitoring_map |> 
      addPolygons(data = shapefile, color = "blue", fill = TRUE, fillOpacity = 0.5, group = shapefile_name)
  } else if ("POINT" %in% geom_type) {
    # Add point layers using addCircleMarkers
    usgs_damrev_monitoring_map <- usgs_damrev_monitoring_map |> 
      addCircleMarkers(data = shapefile, color = "red", radius = 5, group = shapefile_name)
  } else if ("LINE" %in% geom_type) {
    # Add line layers using addPolylines
    usgs_damrev_monitoring_map <- usgs_damrev_monitoring_map |> 
      addPolylines(data = shapefile, color = "green", group = shapefile_name)
  }
}

usgs_damrev_monitoring_map <- usgs_damrev_monitoring_map |> 
  addLayersControl(
    overlayGroups = names(shapefile_list), #TODO clean up so that it is easy to differentiate layers, add a pop-ups, etc
    options = layersControlOptions(collapsed = FALSE)
  )
```

Showing layers on map

#TODO next steps, clean up so that it is easy to differentiate layers, add a pop-ups, etc. 

```{r, echo=FALSE}
usgs_damrev_monitoring_map

#TODO continue to add the rest of shapefiles, then save as #RDS

# saveRDS(map_with_points, "data-raw/usgs_dam_removal_map/usgs_damrev_monitoring_map.RDS")

```

